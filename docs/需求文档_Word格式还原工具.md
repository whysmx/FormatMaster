# Word格式还原工具 - 产品需求文档 (PRD)

## 1. 项目概述

### 1.1 项目名称
Word格式还原工具 (Word Format Restorer)

### 1.2 项目背景
用户在工作中需要将多个合同模板按照统一的 `examples/正常格式.docx` 格式进行排版。当前使用AI助手（Claude Code + document-skill）进行处理，存在以下问题：
- 依赖AI服务，有使用成本
- 需要对话交互，操作繁琐
- 无法批量处理
- 速度较慢

### 1.3 项目目标
开发一个独立的软件工具，能够：
- 无需AI，本地运行
- 快速批量处理Word文档
- 将 `examples/正常格式.docx` 的格式100%还原到 `examples/错乱格式.docx`
- 零成本使用

**中长期方向（Web化）：**
- 支持“标准格式库”，存储多份完整的标准docx
- 用户可选择某个标准格式进行转换
- 支持导入文档并沉淀为标准格式库

### 1.4 目标用户
- 需要统一Word文档格式的办公人员
- 需要批量处理合同模板的业务人员
- 非技术人员（需要简单易用的界面）

### 1.5 当前项目状态
**已有测试文档：**
- `examples/错乱格式.docx` (148KB) - 待处理的原始文档，格式混乱
- `examples/正常格式.docx` (119KB) - 人工处理后的标准文档，用于验证格式还原的准确性

**验证方法：**
当文档内容一致时，工具处理 `examples/错乱格式.docx` 后，输出结果应与 `examples/正常格式.docx` 的XML完全一致（通过XML对比验证，见“XML一致性规则”）。

**适用前提（必须满足）：**
- 内容一致的判定：所有内容承载XML 结构与文本 100%一致（如 `word/document.xml`、`word/header*.xml`、`word/footer*.xml`、`word/footnotes.xml`、`word/endnotes.xml`、`word/comments.xml`、`word/numbering.xml`、`word/people.xml`）
- 仅在“内容一致”的前提下，才要求“完整XML 100%一致”
- 若内容不一致，仅输出格式差异报告，不进行格式还原，也不作为“XML 100%一致”验收依据

**XML一致性规则：**
- 对比范围覆盖 docx 内全部XML文件
- 允许对非确定性字段进行规范化（如 rsid、时间戳、关系顺序、空白差异），仅在“内容一致”的前提下启用

**非确定性字段清单（初版，可调整）：**
- `w:rsid*`（如 `w:rsidR`, `w:rsidRPr`, `w:rsidP`, `w:rsidDel`, `w:rsidRDefault`）
- `cp:revision`
- `dcterms:created`, `dcterms:modified`

---

## 2. 核心功能需求

### 2.1 功能优先级

#### P0 (核心功能 - 必须实现)
- [x] 单个文档格式还原
- [ ] 批量文档格式还原
- [ ] 命令行接口
- [x] 格式还原准确性验证（通过对比测试文档）
- [ ] 格式对比功能（评估系统）

#### P1 (重要功能 - 首期实现)
- [ ] 格式可视化报告
- [ ] 错误处理和日志
- [ ] 进度显示

#### P2 (增强功能 - 后期迭代)
- [ ] 图形用户界面
- [ ] 配置文件支持
- [ ] Web服务接口
- [ ] 在线预览

### 2.2 功能详细说明

#### 2.2.1 单个文档格式还原 (P0)

**功能描述：** 将 `examples/正常格式.docx` 的格式应用到单个待处理文档（如 `examples/错乱格式.docx`）

**输入：**
- `examples/正常格式.docx` 路径（提供格式标准）
- `examples/错乱格式.docx` 路径（需要被格式化）
- 输出文档路径（可选，默认添加"_已格式化"后缀）

**输出：**
- 格式化后的文档

**格式还原范围：**
- ✅ 字体样式（字体名称、字号、颜色、加粗、斜体等）
- ✅ 段落样式（对齐方式、行距、段前段后间距、首行缩进）
- ✅ 标题样式（Heading 1-9）
- ✅ 编号和项目符号样式
- ✅ 表格样式
- ✅ 页面设置（纸张大小、页边距）
- ✅ 保留目标文档页眉页脚内容（不覆盖）
- ✅ 保留原内容关系（图片、超链接、注释、脚注/尾注等内容相关关系不丢失）
- ✅ 处理 `word/document.xml` 中的直接格式（段落/字符级属性），将其统一到标准文档的格式规则

**技术实现：**
通过复制 `examples/正常格式.docx` 中的格式定义文件到 `examples/错乱格式.docx`，并合并关系文件（保留原内容关系），同时重写 `word/document.xml` 中的直接格式：
```
word/styles.xml          - 样式定义
word/numbering.xml       - 编号定义
word/settings.xml        - 文档设置
word/fontTable.xml       - 字体表
word/_rels/document.xml.rels - 关系文件（合并：保留目标内容关系 + 补齐标准格式关系）
```
页眉页脚：保留目标文档原有 header/footer 内容，不覆盖。

**命令行示例：**
```bash
# 使用 examples/正常格式.docx 作为格式基准，处理 examples/错乱格式.docx
format-restorer examples/正常格式.docx examples/错乱格式.docx -o 错乱格式_已还原.docx

# 验证：输出的XML应该与 examples/正常格式.docx 完全一致
format-restorer --compare examples/正常格式.docx examples/错乱格式_已还原.docx
```

**成功标准：**
- 输出文档的完整XML与 `examples/正常格式.docx` 一致（仅在“内容一致”的适用前提下，且遵循XML一致性规则）
- `examples/错乱格式.docx` 的内容保持不变（含图片、超链接、注释、脚注/尾注等内容关系）
- 处理时间 < 1秒
- 通过XML对比验证：解压目录内全部XML文件无差异（仅在“内容一致”的适用前提下）

#### 2.2.2 批量文档格式还原 (P0)

**功能描述：** 一次性处理多个文档

**输入：**
- `examples/正常格式.docx` 路径
- 待处理文档列表（支持通配符或目录，如 `examples/错乱格式.docx`）
- 输出目录（可选）

**输出：**
- 多个格式化后的文档

**默认行为：**
- 单个文件失败不影响其他文件（继续处理）
- 若输出文件已存在，自动追加序号后缀（如 `_已还原_1`）避免覆盖

**命令行示例：**
```bash
# 处理多个文件
format-restorer examples/正常格式.docx 文件1.docx 文件2.docx 文件3.docx

# 使用通配符
format-restorer examples/正常格式.docx *.docx

# 指定输出目录
format-restorer examples/正常格式.docx contracts/*.docx -o formatted/
```

**成功标准：**
- 所有文档格式还原正确
- 显示处理进度
- 失败时有明确错误提示

#### 2.2.3 格式对比功能 (P0 - 验证工具)

**功能描述：** 对比两个文档的XML差异（默认全量对比），输出格式差异报告，用于验证格式还原的准确性

**输入：**
- `examples/正常格式.docx` 路径
- 待验证文档路径（如工具输出的文档）

**输出：**
- 格式差异报告
- 相似度评分
- XML文件差异列表（覆盖 docx 内全部XML文件）

**前提说明：**
- 若 `examples/正常格式.docx` 与 `examples/错乱格式.docx` 内容一致，可进行“完整XML一致性”验证（含规范化规则）
- 若内容不一致，仅输出格式差异评分与报告，不进行格式还原，也不作为“XML 100%一致”验收依据

**实现方式：**
```bash
# 方式1：完整对比（默认，包含所有XML）
format-restorer --compare examples/正常格式.docx 输出文档.docx

# 方式2：完整对比（显式）
format-restorer --compare --full examples/正常格式.docx 输出文档.docx

# 方式3：仅对比特定格式文件
format-restorer --compare --file styles.xml examples/正常格式.docx 输出文档.docx
```

**报告示例：**
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 格式对比报告
格式基准文档: examples/正常格式.docx
待验证文档: 错乱格式_已还原.docx
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ XML文件对比（节选）:
  • styles.xml: 完全一致 ✓
  • numbering.xml: 完全一致 ✓
  • settings.xml: 完全一致 ✓
  • fontTable.xml: 完全一致 ✓
  • header*.xml: 完全一致 ✓
  • footer*.xml: 完全一致 ✓

📈 格式相似度: 100%

✅ 结论: 格式还原完全成功！
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**成功标准：**
- 能够准确识别全部XML文件的差异
- 提供清晰的对比报告
- 相似度计算准确（按XML节点/属性差异比例计算，同时保留文件级一致性统计）
- 支持命令行输出，便于自动化测试
- 当内容一致时，支持完整XML一致性验证

#### 2.2.4 格式可视化报告 (P1)

**功能描述：** 生成格式摘要报告，让用户了解文档格式

**报告内容：**
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📄 文档格式报告
文件: examples/错乱格式.docx
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 基本统计:
  • 段落数: 45
  • 字符数: 12,345
  • 样式数: 8
  • 表格数: 3

🎨 样式统计:
  • 字体样式: 12 种
  • 段落样式: 8 种
  • 编号样式: 3 种
  • 表格样式: 2 种

📝 主要格式:
  样式名称    字体      字号    行距    首行缩进
  ──────────────────────────────────────
  Normal     宋体      12pt    1.5倍   2字符
  Heading1   宋体      16pt    1.5倍   0字符
  Heading2   宋体      14pt    1.5倍   0字符

📏 页面设置:
  • 纸张: A4
  • 页边距: 上2.54cm 下2.54cm 左3.17cm 右3.17cm
  • 页眉: 有
  • 页脚: 有

✅ 格式完整性检查:
  • styles.xml: 完整
  • numbering.xml: 完整
  • settings.xml: 完整
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**命令行示例：**
```bash
format-restorer --report examples/错乱格式.docx
```

#### 2.2.5 标准格式库 (P1 - Web版核心)

**功能描述：** 支持多个标准docx的存储与管理，供后续选择使用

**关键能力：**
- 导入docx并入库（形成“标准格式”条目）
- 按“文件名”管理标准格式
- 选择标准格式条目，对待处理文档进行转换
- 标准格式库可复用、可扩展

**数据结构（最小可行）：**
- 标准格式条目：`文件名` + `源docx`

**成功标准：**
- 用户可通过改名完成标准格式条目管理
- 用户可选择指定文件名进行转换
- 转换结果仍满足“内容一致时，完整XML一致”的验收规则

---

## 3. 非功能需求

### 3.1 性能要求
- 单个文档处理时间 < 1秒
- 支持批量处理100+文档
- 内存占用 < 100MB

### 3.2 可靠性要求
- 不损坏原始文档
- 不修改文档内容
- 处理失败时有明确错误提示
- 支持操作中断和恢复

### 3.3 易用性要求
- 命令行参数清晰
- 提供帮助文档
- 错误信息友好
- 进度显示清晰

### 3.4 兼容性要求
- 支持 .docx 格式（Word 2007+）
- 支持 Windows / macOS / Linux
- Python 3.7+
- Web版本支持主流浏览器（Chrome/Edge/Safari）

### 3.5 可维护性要求
- 代码模块化
- 注释完整
- 单元测试覆盖率 > 80%

---

## 4. 技术方案

### 4.1 技术栈
- **语言:** Python 3.7+
- **核心库:** zipfile (标准库), shutil (标准库), tempfile (标准库)
- **可选库:** python-docx (用于格式分析)
- **打包工具:** PyInstaller (生成独立exe)

### 4.2 核心算法

#### 格式还原算法
```
1. 解压 `examples/正常格式.docx` 到临时目录
2. 解压 `examples/错乱格式.docx` 到临时目录
3. 复制以下格式文件:
   - 正常格式_解压/word/styles.xml → 错乱格式_解压/word/styles.xml
   - 正常格式_解压/word/numbering.xml → 错乱格式_解压/word/numbering.xml
   - 正常格式_解压/word/settings.xml → 错乱格式_解压/word/settings.xml
   - 正常格式_解压/word/fontTable.xml → 错乱格式_解压/word/fontTable.xml
   - 正常格式_解压/word/_rels/document.xml.rels → 错乱格式_解压/word/_rels/document.xml.rels（合并：保留目标内容关系 + 补齐标准格式关系）
4. 重写 `word/document.xml` 的直接格式（段落/字符级属性），统一到标准文档的格式规则
5. 重新打包待处理文档为输出.docx
6. 清理临时文件
7. （可选）自动对比验证：解压输出文档和 `examples/正常格式.docx`，对比全部XML文件
```

#### 格式对比算法
```
1. 解压两个文档到临时目录
2. 读取全部XML文件
3. 规范化XML（统一属性顺序、去除空白差异、过滤非确定性字段）
4. 逐个文件对比:
   - 如果完全相同 → ✓ 一致
   - 如果有差异 → 列出差异位置
5. 计算相似度 = XML节点/属性差异比例（并保留文件级一致性统计）
6. 生成对比报告
```

### 4.3 项目结构（建议）
```
word-format-restorer/
├── src/
│   └── restorer/
│       ├── __init__.py
│       ├── core.py          # 核心格式还原逻辑
│       ├── comparer.py      # 格式对比器（含XML规范化）
│       ├── report.py        # 格式报告生成（P1）
│       └── cli.py           # 命令行接口
├── tests/
│   ├── test_core.py
│   ├── test_comparer.py
│   └── test_cli.py
├── examples/
│   ├── 正常格式.docx        # 格式基准文档
│   └── 错乱格式.docx        # 待处理文档
├── docs/
│   ├── 需求文档_Word格式还原工具.md # 产品需求文档
│   └── usage.md             # 使用说明与示例
├── scripts/
│   ├── unpack_docx.py       # 解压/重打包工具
│   └── diff_xml.py          # XML对比辅助脚本
├── pyproject.toml
├── README.md
└── LICENSE
```

---

## 5. 开发计划

### 5.1 第一阶段 (MVP - 1周) - 当前阶段
- [x] 核心格式还原功能（基于document-skill实现）
- [ ] 命令行接口
- [ ] 格式对比验证功能
- [ ] 基本错误处理
- [ ] 单元测试

**测试用例：**
- 使用 `examples/正常格式.docx` 作为格式基准
- 处理 `examples/错乱格式.docx`
- 验证输出与 `examples/正常格式.docx` 全部XML 100%一致

**交付物：** 可用的命令行工具 + 验证通过

### 5.2 第二阶段 (增强 - 1周)
- [ ] 格式分析报告
- [ ] 批量处理优化
- [ ] 完善文档
- [ ] 性能测试

**交付物：** 功能完整的命令行工具

### 5.3 第三阶段 (优化 - 1周)
- [ ] 错误处理增强
- [ ] 进度显示
- [ ] 日志系统
- [ ] 打包成独立可执行文件

**交付物：** 生产级工具

### 5.4 第四阶段 (可选 - 2周)
- [ ] 图形用户界面
- [ ] Web服务接口
- [ ] 配置文件支持

**交付物：** 全功能工具包

---

## 6. 验收标准

### 6.1 功能验收
- [x] 能够成功还原格式（基于document-skill验证）
- [ ] 格式还原准确率 100%（仅在内容一致前提下，通过XML对比验证）
- [ ] 批量处理不遗漏文件
- [ ] 格式报告准确完整
- [ ] 格式对比准确识别差异（已有对比文档）
- [ ] 内容不一致时，仅输出格式差异报告，不进行格式还原

### 6.2 性能验收
- [ ] 单文档处理 < 1秒
- [ ] 100文档批量处理 < 2分钟
- [ ] 内存占用 < 100MB

### 6.3 质量验收
- [ ] 单元测试通过率 100%
- [ ] 代码覆盖率 > 80%
- [ ] 无critical级别bug
- [ ] 文档完整

### 6.4 真实场景验收
使用现有测试文档进行完整验证：
```bash
# 1. 处理文档
format-restorer examples/正常格式.docx examples/错乱格式.docx -o output.docx

# 2. 验证格式
format-restorer --compare examples/正常格式.docx output.docx

# 3. 预期结果
# 格式相似度: 100%
# 所有XML文件: 完全一致 ✓
```

---

## 7. 风险评估

### 7.1 技术风险
| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 复杂格式无法还原 | 高 | 低 | 充分测试，保留人工干预选项 |
| 性能不达标 | 中 | 低 | 优化算法，使用多线程 |
| 兼容性问题 | 中 | 中 | 多平台测试，使用标准库 |

### 7.2 业务风险
| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 用户需求变更 | 中 | 中 | 模块化设计，预留扩展接口 |
| 竞品出现 | 低 | 低 | 保持技术领先，提升用户体验 |

---

## 8. 成功指标

### 8.1 定量指标
- 处理速度: > 60 文档/分钟
- 格式准确率: 100%
- 用户满意度: > 90%
- 成本节省: > 90% (相比AI方案)

### 8.2 定性指标
- 用户无需学习即可使用
- 处理结果可验证
- 错误信息清晰可理解

### 8.3 真实测试指标
- 通过现有测试文档验证：`examples/正常格式.docx` vs 输出文档
- XML文件100%一致
- 视觉效果完全相同

---

## 9. 后续规划

### 9.1 短期 (3个月内)
- 收集用户反馈
- 优化核心功能
- 修复bug

### 9.2 中期 (6个月内)
- 开发图形界面
- 支持更多格式
- 发布到PyPI

### 9.3 长期 (1年内)
- 开发在线版本
- 支持企业定制
- 建立用户社区

---

## 10. 附录

### 10.1 术语表
- **examples/正常格式.docx:** 提供格式标准的Word文档
- **examples/错乱格式.docx:** 需要被格式化的Word文档
- **格式还原:** 将 `examples/正常格式.docx` 的格式应用到 `examples/错乱格式.docx`
- **格式文件:** 指定义文档格式的XML文件（styles.xml, numbering.xml等）

### 10.2 参考资料
- [OOXML格式规范](https://docs.microsoft.com/en-us/openspecs/office_standards/)
- [python-docx文档](https://python-docx.readthedocs.io/)
- [Word文档结构](https://learn.microsoft.com/en-us/office/open-xml/word-processing)

### 10.3 测试文档说明
项目目录中已有测试文档：
- `examples/正常格式.docx` (119KB) - 人工处理后的标准格式文档，作为格式还原的参照标准
- `examples/错乱格式.docx` (148KB) - 格式混乱的原始文档，用于测试格式还原功能

### 10.4 验证流程
1. 使用 `examples/正常格式.docx` 作为格式基准
2. 对 `examples/错乱格式.docx` 执行格式还原
3. 对比输出文档与 `examples/正常格式.docx` 的全部XML文件
4. 验证所有XML文件完全一致
5. 确认视觉效果相同
